{% extends 'tienda/base.html' %}
{% load static %}

{% block extra_css %}
<style>
.product-detail-container {
  display: flex;
  gap: 2rem;
  max-width: 1200px;
  margin: 2rem auto;
  padding: 0 1rem;
}

/* Imagen producto */
.product-image {
  flex: 1 1 50%;
  max-height: 400px;
  overflow: hidden;
  border-radius: 14px;
  box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
  transition: transform 0.4s ease;
  cursor: pointer;
}

.product-image img {
  width: 100%;
  height: 100%;
  object-fit: cover;
  border-radius: 14px;
}

.product-image:hover img {
  transform: scale(1.05);
}

/* Contenido texto detalle */
.product-info {
  flex: 1 1 50%;
  display: flex;
  flex-direction: column;
  justify-content: space-between;
}

/* Título y descripción */
.product-info h1 {
  font-size: 2rem;
  color: #000;
  font-weight: 700;
  margin-bottom: 1rem;
}

.product-info p {
  color: #444;
  font-size: 1rem;
  line-height: 1.4;
  margin-bottom: 1.5rem;
}

/* Tarjeta detalles de la subasta */
.auction-details-card {
  background: #fff;
  border-radius: 14px;
  padding: 1.5rem;
  box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
  margin-bottom: 2rem;
}

.auction-details-card h4 {
  margin-bottom: 1rem;
  font-weight: 700;
  color: #222;
  border-bottom: 3px solid #999;
  padding-bottom: 0.4rem;
}

.auction-details-card ul {
  list-style: none;
  padding: 0;
  margin: 0;
}

.auction-details-card li {
  display: flex;
  justify-content: space-between;
  padding: 0.6rem 0;
  border-bottom: 1px solid #eee;
  font-weight: 600;
  color: #333;
}

.auction-details-card li strong {
  color: #000;
}

/* Formulario puja */
.bid-form {
  background: #000;
  color: white;
  border-radius: 14px;
  padding: 1.5rem;
  box-shadow: 0 8px 24px rgba(0, 0, 0, 0.4);
  font-weight: 600;
}

.bid-form h4 {
  margin-bottom: 1rem;
  font-size: 1.5rem;
  font-weight: 700;
}

.bid-form form {
  display: flex;
  gap: 1rem;
  flex-wrap: wrap;
  align-items: center;
}

.bid-form input[type="number"] {
  flex: 1 1 70%;
  padding: 0.7rem 1rem;
  border-radius: 40px;
  border: none;
  font-size: 1rem;
  font-weight: 600;
}

.bid-form button {
  flex: 1 1 25%;
  background-color: #fff;
  color: #000;
  font-weight: 700;
  padding: 0.7rem 0;
  border-radius: 40px;
  border: none;
  cursor: pointer;
  transition: background-color 0.3s ease;
}

.bid-form button:hover {
  background-color: #333;
  color: white;
}

/* Mensajes de alerta */
.alert {
  border-radius: 12px;
  padding: 1rem 1.5rem;
  margin-bottom: 1rem;
  font-weight: 600;
  box-shadow: 0 2px 12px rgba(0, 0, 0, 0.12);
}

/* Lista de pujas */
.bid-history {
  background: #fff;
  border-radius: 14px;
  box-shadow: 0 4px 16px rgba(0,0,0,0.1);
  padding: 1rem;
  max-height: 320px;
  overflow-y: auto;
}

.bid-history li {
  display: flex;
  justify-content: space-between;
  padding: 0.75rem 1rem;
  border-bottom: 1px solid #eee;
  font-weight: 600;
  color: #222;
}

.bid-history li:last-child {
  border-bottom: none;
}

.bid-history .username {
  font-weight: 700;
}

.bid-history .timestamp {
  color: #666;
  font-size: 0.85rem;
}

/* Contador regresivo */
.countdown {
  font-weight: 700;
  color: #000;
  font-size: 1.1rem;
}

/* --- Responsive --- */

/* Tablets y pantallas medianas */
@media (max-width: 992px) {
  .product-detail-container {
    flex-direction: column;
    padding: 1rem;
  }

  .product-image,
  .product-info {
    flex: 1 1 100%;
  }

  .product-image {
    max-height: 350px;
  }

  .bid-form form {
    flex-direction: column;
  }

  .bid-form input[type="number"],
  .bid-form button {
    flex: 1 1 100%;
  }

  .bid-form button {
    margin-top: 1rem;
  }

  .bid-history {
    max-height: 250px;
  }
}

/* Móviles pequeños */
@media (max-width: 576px) {
  .product-detail-container {
    margin: 1rem;
    padding: 0.5rem;
  }

  .product-image {
    max-height: 280px;
  }

  .product-info h1 {
    font-size: 1.5rem;
  }

  .auction-details-card h4 {
    font-size: 1.2rem;
  }

  .bid-form h4 {
    font-size: 1.3rem;
  }

  .bid-history {
    max-height: 180px;
  }
}

</style>
{% endblock %}

{% block content %}
<div class="container mt-4 product-detail-container">
  <div class="product-image">
    <img src="{{ subasta.producto.imagen.url }}" alt="{{ subasta.producto.nombre }}">
  </div>
  <div class="product-info">
    <h1>{{ subasta.producto.nombre }}</h1>
    <p>{{ subasta.producto.descripcion|default:"Descripción no disponible." }}</p>

    <div class="auction-details-card">
     <h4>Detalles de la Subasta</h4>
     <ul>
      <li><span>Precio inicial:</span> <strong>${{ subasta.precio_inicial }}</strong></li>
      <li><span>Puja actual:</span> <strong id="puja-actual">${{ subasta.precio_actual }}</strong></li>
      <li><span>Tiempo restante:</span> 
       <strong class="countdown" data-end="{{ subasta.fecha_finalizacion|date:'c' }}"></strong>
      </li>
      <li><span>Fecha de inicio:</span> {{ subasta.fecha_inicio|date:"d/m/Y H:i:s" }}</li>
      <li><span>Fecha de finalización:</span> {{ subasta.fecha_finalizacion|date:"d/m/Y H:i:s" }}</li>
     </ul>
    </div>

    {% if user.is_authenticated %}
    <div class="bid-form">
      <h4>Realizar Puja</h4>
      <form method="post" id="form-puja" action="">
        {% csrf_token %}
        <label for="monto-puja" class="form-label">Monto de la Puja ($)</label>
        <input type="number" class="form-control" id="monto-puja" name="monto" placeholder="Ej: 4300" required>
        <button type="submit" class="btn btn-warning w-100 mt-2">Enviar Puja</button>
      </form>
    </div>
    {% else %}
    <div class="alert alert-warning">
      <a href="{% url 'tienda:login' %}?next={{ request.path }}" class="alert-link">Inicia sesión</a> para poder pujar.
    </div>
    {% endif %}
  </div>
</div>

<div class="container mt-4">
  <div class="bid-history">
    <h4>Historial de Pujas</h4>
    <ul id="lista-pujas">
      {% for puja in pujas %}
      <li>
        <span class="username">{{ puja.usuario.username }}</span>
        <small class="timestamp ms-2">{{ puja.fecha|date:"d/m/Y H:i" }}</small>
        <span class="badge bg-primary rounded-pill">${{ puja.monto }}</span>
      </li>
      {% empty %}
      <li>No hay pujas aún.</li>
      {% endfor %}
    </ul>
  </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
  // --- Contador regresivo ---
  const countdownElem = document.querySelector('.countdown');
  const endDateStr = countdownElem?.dataset.end;
  if (endDateStr) {
    const endDate = new Date(endDateStr).getTime();
    function updateCountdown() {
      const now = new Date().getTime();
      const distance = endDate - now;
      if (distance < 0) {
        countdownElem.textContent = "Subasta finalizada";
        document.getElementById('form-puja')?.setAttribute('disabled', 'disabled');
        return;
      }
      const days = Math.floor(distance / (1000 * 60 * 60 * 24));
      const hours = Math.floor((distance % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
      const minutes = Math.floor((distance % (1000 * 60 * 60)) / (1000 * 60));
      const seconds = Math.floor((distance % (1000 * 60)) / 1000);
      countdownElem.textContent = `${days}d ${hours}h ${minutes}m ${seconds}s`;
    }
    updateCountdown();
    setInterval(updateCountdown, 1000);
  }

  // --- Manejo de puja en tiempo real ---
  const formPuja = document.getElementById('form-puja');
  if (formPuja) {
    formPuja.addEventListener('submit', function(e) {
      e.preventDefault();
      const montoInput = document.getElementById('monto-puja');
      const monto = parseFloat(montoInput.value);
      const pujaActualElem = document.getElementById('puja-actual');
      const pujaActual = parseFloat(pujaActualElem.textContent.replace(/\$/g,''));
      if (monto <= pujaActual) {
        alert(`Debes pujar más de $${pujaActual}`);
        return;
      }

      // Enviar al servidor vía fetch
      fetch("", {
        method: "POST",
        headers: {
          'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
          'Content-Type': 'application/x-www-form-urlencoded',
          'X-Requested-With': 'XMLHttpRequest'
        },
        body: `monto=${monto}`
      })
      .then(response => response.json())
      .then(data => {
        if (data.success) {
          // Actualizar precio
          pujaActualElem.textContent = `$${data.nuevo_precio}`;
          // Agregar a historial
          const lista = document.getElementById('lista-pujas');
          const li = document.createElement('li');
          li.innerHTML = `<span class="username">${data.usuario}</span>
                          <small class="timestamp ms-2">${new Date().toLocaleString()}</small>
                          <span class="badge bg-primary rounded-pill">$${data.nuevo_precio}</span>`;
          lista.prepend(li);
          // Limpiar input y actualizar mínimo
          montoInput.value = "";
          montoInput.min = parseFloat(data.nuevo_precio) + 1;
        } else {
          alert(data.message || "Error al procesar la puja");
        }
      })
      .catch(err => {
        console.error(err);
        alert("Error al conectar con el servidor");
      });
    });
  }
});
</script>
{% endblock %}

